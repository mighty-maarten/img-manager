# Deployment Stack - Successfully Deployed

**Date**: December 8, 2025, 8:25 PM UTC  
**Stack Name**: `img-manager-prod-deployment-stack`  
**Status**: ✅ CREATE_COMPLETE  
**Deployment Time**: 138 seconds

## Stack Outputs

| Output | Value |
|--------|-------|
| **Pipeline Name** | `img-manager-prod-deployment-pipeline` |
| **CodeDeploy Application** | `img-manager-prod-app` |
| **Deployment Group** | `img-manager-prod-ec2-deployment-group` |
| **Artifacts Bucket** | `img-manager-prod-deployment-artifacts` |

## Deployed Resources (19 total)

### Core CI/CD Components

1. **CodePipeline**: `img-manager-prod-deployment-pipeline`
   - 4 stages: Source → Build → Approval → Deploy
   - Trigger: POLL (checks GitHub every minute)
   - Artifacts stored in S3 with 30-day lifecycle

2. **CodeBuild Project**: `img-manager-prod-build`
   - Environment: Amazon Linux 2.5
   - Compute: SMALL
   - Build spec: `buildspec.yml` from repository
   - Caching enabled for faster builds

3. **CodeDeploy Application**: `img-manager-prod-app`
   - Deployment Group: `img-manager-prod-ec2-deployment-group`
   - Target: EC2 instances tagged with `img-manager-prod-deployment-target=true`
   - Configuration: ALL_AT_ONCE
   - Auto-rollback enabled on failure

### S3 Bucket

4. **Artifacts Bucket**: `img-manager-prod-deployment-artifacts`
   - Versioning: Enabled
   - Encryption: S3-managed (SSE-S3)
   - Lifecycle: Delete artifacts after 30 days
   - Removal Policy: RETAIN

### IAM Roles (6 total)

5. **Pipeline Role**: `img-manager-prod-codepipeline-role`
   - Permissions: S3, CodeBuild, CodeDeploy

6. **Build Role**: `img-manager-prod-codebuild-role`
   - Permissions: CloudWatch Logs, S3 artifacts

7. **Deployment Group Role**: Auto-generated by CodeDeploy
   - Permissions: EC2, Auto Scaling, ELB

8. **Source Action Role**: For GitHub integration

9. **Build Action Role**: For CodeBuild integration

10. **Approval Action Role**: For manual approval with SNS

11. **Deploy Action Role**: For CodeDeploy integration

### IAM Policies (5 total)

- Default policies for each role with least-privilege permissions

### EventBridge Rule

12. **Pipeline State Change Rule**: `img-manager-prod-pipeline-state-change`
    - Monitors pipeline execution state (FAILED, SUCCEEDED)
    - Publishes to SNS topic: `img-manager-prod-on-error-topic`

## Pipeline Configuration

### Source Stage
- **Provider**: GitHub
- **Repository**: `mighty-maarten/img-manager`
- **Branch**: `main`
- **Trigger**: POLL (every minute)
- **Authentication**: GitHub token from Secrets Manager (`/cicd/github_token`)

### Build Stage
- **Provider**: CodeBuild
- **Project**: `img-manager-prod-build`
- **Buildspec**: `buildspec.yml`
- **Artifacts**: Packaged application code

### Approval Stage
- **Type**: Manual approval
- **Notification**: SNS email to `maarten.thoelen@mighty.be`
- **Message**: "Please review the build and approve deployment to production."

### Deploy Stage
- **Provider**: CodeDeploy
- **Application**: `img-manager-prod-app`
- **Deployment Group**: `img-manager-prod-ec2-deployment-group`
- **Target**: EC2 instance `i-0cc082526929a115b`
- **AppSpec**: `appspec.yml` from build artifacts

## Deployment Target

**EC2 Instance**: `i-0cc082526929a115b`
- **Tag**: `img-manager-prod-deployment-target=true`
- **Elastic IP**: `54.228.200.74`
- **Domain**: `img-manager.mighty.be`
- **CodeDeploy Agent**: Installed and running

## Issue Resolved

### Problem
Initial deployment attempts failed with:
```
AWS::EarlyValidation::ResourceExistenceCheck hook failed
```

### Root Cause
The S3 artifacts bucket (`img-manager-prod-deployment-artifacts`) already existed from a previous failed deployment. The bucket has a `RETAIN` removal policy, so it wasn't deleted when the stack was deleted.

### Solution
Deleted the existing empty bucket:
```bash
aws s3 rb s3://img-manager-prod-deployment-artifacts --profile mighty
```

After removing the bucket, the deployment succeeded immediately.

## Code Changes

### Fixed GitHub Token Retrieval
Updated `infrastructure/lib/deployment-stack.ts` to properly extract the token from JSON:
```typescript
// Extract token from JSON structure: {"github-token":"ghp_..."}
const githubTokenValue = githubToken.secretValueFromJson('github-token');
```

### Temporary Change: POLL Trigger
Changed GitHub trigger from `WEBHOOK` to `POLL` to avoid webhook validation issues:
```typescript
trigger: cdk.aws_codepipeline_actions.GitHubTrigger.POLL
```

**Note**: This can be changed back to `WEBHOOK` later for instant deployments, but POLL works reliably and checks every minute.

## Next Steps

Tasks 24-33 are now ready to execute:
- ✅ Task 22: GitHub token verified
- ✅ Task 23: Deployment stack deployed
- ⏭️ Task 24: Verify CodePipeline creation
- ⏭️ Task 25: Verify CodeBuild project
- ⏭️ Task 26: Verify CodeDeploy configuration
- ⏭️ Task 27: Verify SNS notifications
- ⏭️ Task 28: Test manual pipeline execution
- ⏭️ Task 29: Verify deployment on EC2
- ⏭️ Task 30: Test automatic pipeline trigger
- ⏭️ Task 31: Verify artifacts cleanup
- ⏭️ Task 32: Document deployment process
- ⏭️ Task 33: Final checkpoint

## Monitoring

### CloudWatch Logs
- CodeBuild logs: `/aws/codebuild/img-manager-prod-build`
- Application logs: `img-manager-prod-cloudwatch-logs`

### SNS Notifications
- Topic: `img-manager-prod-on-error-topic`
- Subscriber: `maarten.thoelen@mighty.be`
- Events: Pipeline failures, successes, manual approvals

### AWS Console Links
- **Pipeline**: https://eu-west-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/img-manager-prod-deployment-pipeline
- **CodeBuild**: https://eu-west-1.console.aws.amazon.com/codesuite/codebuild/projects/img-manager-prod-build
- **CodeDeploy**: https://eu-west-1.console.aws.amazon.com/codesuite/codedeploy/applications/img-manager-prod-app
- **S3 Artifacts**: https://s3.console.aws.amazon.com/s3/buckets/img-manager-prod-deployment-artifacts

## Stack ARN
```
arn:aws:cloudformation:eu-west-1:964213726654:stack/img-manager-prod-deployment-stack/fdc91100-d46a-11f0-a8d0-06b6e52d7889
```
